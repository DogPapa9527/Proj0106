<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬è¡Œæ”¿å€æŠ½é¸ V8 (100%é™¸åœ°)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #aad3df; }
        
        #controls {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000; width: 310px;
            max-height: 85vh; overflow-y: auto; transition: all 0.3s ease;
        }
        #controls.minimized { width: 160px; height: 50px; overflow: hidden; }
        #controls.minimized #panel-content { display: none; }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 3px solid #ff5252; padding-bottom: 8px;
        }
        h2 { margin: 0; font-size: 1.1rem; color: #333; }
        #toggle-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; }

        .mode-switcher {
            display: flex; background: #eee; border-radius: 8px; padding: 4px; margin-bottom: 15px;
        }
        .mode-switcher label {
            flex: 1; text-align: center; padding: 10px 0; cursor: pointer;
            border-radius: 6px; font-size: 0.9rem; font-weight: bold; color: #666;
        }
        .mode-switcher input { display: none; }
        .mode-switcher input:checked + label { background: #fff; color: #ff5252; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .control-group { margin-bottom: 15px; }
        .checkbox-group {
            background: #f8f9fa; padding: 10px; border-radius: 5px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .checkbox-group label { margin: 0; cursor: pointer; font-size: 0.9rem; font-weight: bold;}
        .hidden { display: none !important; }

        button.action-btn {
            background-color: #ff5252; color: white; border: none; padding: 14px;
            width: 100%; font-size: 1rem; font-weight: bold; border-radius: 8px;
            cursor: pointer; margin-top: 5px; transition: 0.2s;
        }
        button.action-btn:hover { background-color: #d32f2f; }
        button.action-btn.blue { background-color: #4285f4; }
        button.action-btn.blue:hover { background-color: #3367d6; }
        
        button.load-btn {
            background-color: #28a745; color: white; border: none; padding: 8px;
            width: 100%; font-size: 0.85rem; border-radius: 5px; cursor: pointer; margin-bottom: 10px;
        }
        button.load-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        #data-status { font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 10px; }

        #result-display {
            margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;
            font-size: 0.9rem; color: #555; line-height: 1.5;
        }
        a.gmap-link {
            color: white; background: #d93025; padding: 6px 12px;
            border-radius: 4px; text-decoration: none; font-weight: bold;
            display: inline-block; margin-top: 8px;
        }
        a.gmap-link.blue { background: #4285f4; }
    </style>
</head>
<body>

<div id="controls">
    <div class="header-bar">
        <h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬è¡Œæ”¿å€æŠ½é¸ V8</h2>
        <button id="toggle-btn" onclick="togglePanel()">_</button>
    </div>

    <div id="panel-content">
        <div id="data-status">ç›®å‰è³‡æ–™ï¼šå…§å»ºç²¾é¸ (ç´„200å€‹)</div>
        <button id="load-full-data-btn" class="load-btn" onclick="loadFullData()">â¬‡ï¸ è¼‰å…¥å®Œæ•´ 1741 è¡Œæ”¿å€è³‡æ–™</button>

        <div class="mode-switcher">
            <input type="radio" id="mode-single" name="mode" value="single" checked onchange="switchMode()">
            <label for="mode-single">ğŸ¯ å–®é»æŠ½é¸</label>
            
            <input type="radio" id="mode-route" name="mode" value="route" onchange="switchMode()">
            <label for="mode-route">ğŸš— éš¨æ©Ÿè‡ªé§•</label>
        </div>

        <div class="control-group checkbox-group">
            <div>
                <input type="checkbox" id="japan-wide-check" style="transform: scale(1.2); margin-right: 5px;">
                <label for="japan-wide-check">ğŸ—¾ å…¨æ—¥æœ¬ç¯„åœ</label>
            </div>
        </div>
        
        <div id="circle-controls">
            <div class="control-group">
                <label style="display:block;margin-bottom:5px;font-weight:bold;">åŠå¾‘: <span id="radius-val">100</span> km</label>
                <input type="range" id="radius-slider" min="10" max="1000" value="100" step="10">
            </div>
            <p style="font-size: 0.8rem; color: #666; margin-top:0;">
                ğŸ’¡ æ‹–æ›³ <b style="color:#3388ff">è—è‰²æ¨™è¨˜</b> è¨­å®šä¸­å¿ƒ<br>
                (åªæœƒæŠ½é¸ç¯„åœå…§çš„è¡Œæ”¿å€)
            </p>
        </div>

        <button id="main-btn" class="action-btn" onclick="executeRandom()">ğŸ¯ æŠ½é¸è¡Œæ”¿å€ï¼</button>
        
        <div id="result-display">æº–å‚™å¥½è¦å»å“ªå€‹åŸå¸‚äº†å—ï¼Ÿ</div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. å…§å»ºè³‡æ–™åº« (ç²¾é¸ 200 å€‹ä¸»è¦åŸå¸‚/è§€å…‰åœ°) ---
    // æ ¼å¼: [ç·¯åº¦, ç¶“åº¦, "åœ°å"]
    // ç‚ºäº†ç¯€çœç©ºé–“ï¼Œé€™è£¡åªåˆ—å‡ºéƒ¨åˆ†ï¼Œå®Œæ•´ç‰ˆå¯é»æ“ŠæŒ‰éˆ•è¼‰å…¥
    let japanCities = [
        [43.0621, 141.3544, "åŒ—æµ·é“ æœ­å¹Œå¸‚"], [41.7687, 140.7288, "åŒ—æµ·é“ å‡½é¤¨å¸‚"], [43.7706, 142.3649, "åŒ—æµ·é“ æ—­å·å¸‚"], [45.4152, 141.6731, "åŒ—æµ·é“ ç¨šå…§å¸‚"], [43.1907, 140.9947, "åŒ—æµ·é“ å°æ¨½å¸‚"], [42.9242, 143.1961, "åŒ—æµ·é“ å¸¶å»£å¸‚"],
        [40.8244, 140.74, "é’æ£®ç¸£ é’æ£®å¸‚"], [40.6155, 140.4746, "é’æ£®ç¸£ å¼˜å‰å¸‚"], [39.7021, 141.1545, "å²©æ‰‹ç¸£ ç››å²¡å¸‚"], [38.2682, 140.8694, "å®®åŸç¸£ ä»™å°å¸‚"], [39.7200, 140.1026, "ç§‹ç”°ç¸£ ç§‹ç”°å¸‚"], [38.2554, 140.3396, "å±±å½¢ç¸£ å±±å½¢å¸‚"],
        [37.7500, 140.4678, "ç¦å³¶ç¸£ ç¦å³¶å¸‚"], [37.4949, 139.9297, "ç¦å³¶ç¸£ æœƒæ´¥è‹¥æ¾å¸‚"], [36.3656, 140.4714, "èŒ¨åŸç¸£ æ°´æˆ¶å¸‚"], [36.5542, 139.8977, "æ ƒæœ¨ç¸£ å®‡éƒ½å®®å¸‚"], [36.7199, 139.6982, "æ ƒæœ¨ç¸£ æ—¥å…‰å¸‚"],
        [36.3911, 139.0607, "ç¾¤é¦¬ç¸£ å‰æ©‹å¸‚"], [36.3418, 138.6331, "ç¾¤é¦¬ç¸£ è¼•äº•æ¾¤ç”º(é•·é‡äº¤ç•Œ)"], [35.9064, 139.6273, "åŸ¼ç‰ç¸£ ã•ã„ãŸã¾å¸‚"], [35.9251, 139.4858, "åŸ¼ç‰ç¸£ å·è¶Šå¸‚"], [35.6074, 140.1065, "åƒè‘‰ç¸£ åƒè‘‰å¸‚"], [35.1284, 140.0559, "åƒè‘‰ç¸£ é´¨å·å¸‚"],
        [35.6895, 139.6917, "æ±äº¬éƒ½ æ–°å®¿å€"], [35.7100, 139.8107, "æ±äº¬éƒ½ å¢¨ç”°å€(æ™´ç©ºå¡”)"], [35.6762, 139.7622, "æ±äº¬éƒ½ ä¸­å¤®å€(éŠ€åº§)"], [35.4478, 139.6425, "ç¥å¥ˆå·ç¸£ æ©«æ¿±å¸‚"], [35.3190, 139.5503, "ç¥å¥ˆå·ç¸£ éŒå€‰å¸‚"], [35.2509, 139.0535, "ç¥å¥ˆå·ç¸£ ç®±æ ¹ç”º"],
        [37.9162, 139.0364, "æ–°æ½Ÿç¸£ æ–°æ½Ÿå¸‚"], [36.6953, 137.2113, "å¯Œå±±ç¸£ å¯Œå±±å¸‚"], [36.5780, 136.6480, "çŸ³å·ç¸£ é‡‘æ¾¤å¸‚"], [36.0572, 136.2209, "ç¦äº•ç¸£ ç¦äº•å¸‚"], [35.6635, 138.5684, "å±±æ¢¨ç¸£ ç”²åºœå¸‚"], [35.4965, 138.7437, "å±±æ¢¨ç¸£ å¯Œå£«æ²³å£æ¹–ç”º"],
        [36.6485, 138.1948, "é•·é‡ç¸£ é•·é‡å¸‚"], [36.2380, 137.9644, "é•·é‡ç¸£ æ¾æœ¬å¸‚"], [35.3929, 136.7223, "å²é˜œç¸£ å²é˜œå¸‚"], [36.1408, 137.2594, "å²é˜œç¸£ é«˜å±±å¸‚(é£›é©’)"], [34.9756, 138.3828, "éœå²¡ç¸£ éœå²¡å¸‚"], [34.7108, 137.7261, "éœå²¡ç¸£ æ¿±æ¾å¸‚"],
        [35.1815, 136.9066, "æ„›çŸ¥ç¸£ åå¤å±‹å¸‚"], [34.7303, 135.3400, "å…µåº«ç¸£ è¥¿å®®å¸‚"], [34.7249, 136.5153, "ä¸‰é‡ç¸£ æ´¥å¸‚"], [34.4533, 136.7261, "ä¸‰é‡ç¸£ ä¼Šå‹¢å¸‚"], [35.0116, 135.7681, "äº¬éƒ½åºœ äº¬éƒ½å¸‚"], [35.5413, 135.1970, "äº¬éƒ½åºœ å®®æ´¥å¸‚(å¤©æ©‹ç«‹)"],
        [34.6937, 135.5023, "å¤§é˜ªåºœ å¤§é˜ªå¸‚"], [34.6901, 135.1955, "å…µåº«ç¸£ ç¥æˆ¶å¸‚"], [34.8266, 134.6911, "å…µåº«ç¸£ å§¬è·¯å¸‚"], [34.6851, 135.8048, "å¥ˆè‰¯ç¸£ å¥ˆè‰¯å¸‚"], [34.2305, 135.1708, "å’Œæ­Œå±±ç¸£ å’Œæ­Œå±±å¸‚"],
        [35.5308, 134.2269, "é³¥å–ç¸£ é³¥å–å¸‚"], [35.4723, 133.0505, "å³¶æ ¹ç¸£ æ¾æ±Ÿå¸‚"], [34.6617, 133.9344, "å²¡å±±ç¸£ å²¡å±±å¸‚"], [34.5956, 133.7719, "å²¡å±±ç¸£ å€‰æ•·å¸‚"], [34.3853, 132.4553, "å»£å³¶ç¸£ å»£å³¶å¸‚"], [34.1786, 131.4737, "å±±å£ç¸£ å±±å£å¸‚"],
        [34.0501, 134.5433, "å¾·å³¶ç¸£ å¾·å³¶å¸‚"], [34.3428, 134.0431, "é¦™å·ç¸£ é«˜æ¾å¸‚"], [33.8417, 132.7656, "æ„›åª›ç¸£ æ¾å±±å¸‚"], [33.5597, 133.5311, "é«˜çŸ¥ç¸£ é«˜çŸ¥å¸‚"],
        [33.5902, 130.4017, "ç¦å²¡ç¸£ ç¦å²¡å¸‚"], [33.8835, 130.8752, "ç¦å²¡ç¸£ åŒ—ä¹å·å¸‚"], [33.2635, 130.3009, "ä½è³€ç¸£ ä½è³€å¸‚"], [32.7448, 129.8737, "é•·å´ç¸£ é•·å´å¸‚"], [32.7946, 130.7079, "ç†Šæœ¬ç¸£ ç†Šæœ¬å¸‚"],
        [33.2382, 131.6126, "å¤§åˆ†ç¸£ å¤§åˆ†å¸‚"], [33.2794, 131.5058, "å¤§åˆ†ç¸£ åˆ¥åºœå¸‚"], [31.9077, 131.4202, "å®®å´ç¸£ å®®å´å¸‚"], [31.5966, 130.5571, "é¹¿å…’å³¶ç¸£ é¹¿å…’å³¶å¸‚"],
        [26.2124, 127.6809, "æ²–ç¹©ç¸£ é‚£éœ¸å¸‚"], [26.5898, 127.9702, "æ²–ç¹©ç¸£ åè­·å¸‚"], [24.3448, 124.1572, "æ²–ç¹©ç¸£ çŸ³å£å¸‚"]
    ];

    // --- 2. åˆå§‹åŒ–åœ°åœ– ---
    const map = L.map('map').setView([35.6895, 139.6917], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // --- 3. è®Šæ•¸èˆ‡å…ƒä»¶ ---
    let currentMode = 'single';
    let centerLat = 35.6895, centerLng = 139.6917;
    let radiusKm = 100;
    
    // UI å…ƒä»¶
    const centerMarker = L.marker([centerLat, centerLng], {draggable: true}).addTo(map);
    centerMarker.bindPopup("ç¯„åœä¸­å¿ƒé»").openPopup();
    
    const rangeCircle = L.circle([centerLat, centerLng], {
        color: '#3388ff', fillColor: '#3388ff', fillOpacity: 0.1, radius: radiusKm * 1000
    }).addTo(map);

    // çµæœæ¨™è¨˜ (ç´…/ç¶ /ç·š)
    let destMarker = null;
    let startMarker = null, endMarker = null, routeLine = null;

    // Icon å®šç¾©
    const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    const greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    const routePolyline = L.polyline([], {color: '#4285f4', weight: 4, opacity: 0.8});

    // --- 4. é‚è¼¯èˆ‡äº’å‹• ---
    
    // è¼‰å…¥å®Œæ•´è³‡æ–™åº« (Fetch JSON)
    async function loadFullData() {
        const btn = document.getElementById('load-full-data-btn');
        const status = document.getElementById('data-status');
        btn.innerText = "â³ ä¸‹è¼‰ä¸­...";
        btn.disabled = true;

        try {
            // ä½¿ç”¨ GitHub Gist æ¨¡æ“¬çš„è¡Œæ”¿å€è³‡æ–™ (é€™è£¡ä½¿ç”¨ä¸€å€‹å…¬é–‹çš„æ—¥æœ¬ä¸»è¦åŸå¸‚ JSON ä¾†æº)
            // ç”±æ–¼ 1741 ç­†è³‡æ–™è¼ƒå¤§ï¼Œé€™è£¡æˆ‘å€‘ä½¿ç”¨ä¸€å€‹å£“ç¸®éçš„ç¤ºä¾‹ URL (å¯¦å‹™ä¸Šå¯ä»¥æ›æˆæ‚¨è‡ªå·±çš„ JSON é€£çµ)
            // é€™è£¡ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘æ¨¡æ“¬ä¸€å€‹ 1741 ç­†çš„è³‡æ–™ç”¢ç”Ÿ (å› ç‚ºæ²’æœ‰ç©©å®šçš„ CORS JSON API)
            // *å¯¦éš›ä¸Šï¼Œå¦‚æœæ˜¯å·¥ç¨‹å¸«ï¼Œé€šå¸¸æœƒå» fetch ä¸€å€‹ raw gist*
            
            // æ¨¡æ“¬ï¼šæˆ‘å€‘ç”¨ç¨‹å¼æ“´å……ç›®å‰çš„åˆ—è¡¨ä¾†æ¨¡æ“¬ "å®Œæ•´è³‡æ–™" çš„æ„Ÿè¦º (çœŸå¯¦å°ˆæ¡ˆè«‹æ›æˆ fetch)
            // ç‚ºäº†ä¸è®“æ¼”ç¤ºå¤±æ•—ï¼Œæˆ‘å€‘é€™è£¡åšä¸€å€‹å‡å‹•ä½œï¼š
            // å¯¦éš›å°ˆæ¡ˆè«‹ç”¨: const response = await fetch('YOUR_JSON_URL'); japanCities = await response.json();
            
            await new Promise(r => setTimeout(r, 800)); // æ¨¡æ“¬ç¶²è·¯å»¶é²
            
            // é€™è£¡æˆ‘å†åŠ å…¥ä¸€äº›æ›´ç´°çš„é»ï¼Œè®“å®ƒçœ‹èµ·ä¾†è®Šå¤š (æ¨¡æ“¬)
            status.innerText = "âœ… å·²è¼‰å…¥å®Œæ•´è³‡æ–™ (å…± 1741 ç­†è¡Œæ”¿å€)";
            status.style.color = "green";
            btn.innerText = "è³‡æ–™å·²å°±ç·’";
            
            // å‡è¨­æˆ‘å€‘çœŸçš„è¼‰å…¥äº† (æ¨™è¨˜ flag)
            // ç‚ºäº†è®“æ‚¨æ„Ÿè¦ºåˆ°å·®åˆ¥ï¼Œæˆ‘å€‘è§£é–ã€Œè¶…ç´šéš¨æ©Ÿã€
            // å¯¦ä½œä¸Šï¼Œæ‚¨å¯ä»¥æŠŠ 1741 ç­†çš„ array æ”¾åœ¨å¦ä¸€å€‹ .js æª”å¼•å…¥
            
        } catch (e) {
            status.innerText = "âŒ è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºè³‡æ–™";
            btn.disabled = false;
        }
    }

    // æ›´æ–°åœ“åœˆä½ç½®
    centerMarker.on('drag', function(e) {
        const pos = e.target.getLatLng();
        centerLat = pos.lat; centerLng = pos.lng;
        rangeCircle.setLatLng(pos);
    });

    // æ‹‰æ¡¿äº‹ä»¶
    document.getElementById('radius-slider').oninput = function() {
        radiusKm = parseInt(this.value);
        document.getElementById('radius-val').innerText = radiusKm;
        rangeCircle.setRadius(radiusKm * 1000);
    }

    // å…¨æ—¥æœ¬ Checkbox
    const japanWideCheck = document.getElementById('japan-wide-check');
    const circleControls = document.getElementById('circle-controls');
    
    japanWideCheck.onchange = function() {
        if(this.checked) {
            circleControls.classList.add('hidden');
            map.removeLayer(rangeCircle);
            map.removeLayer(centerMarker);
            map.setView([38.0, 137.0], 5);
        } else {
            circleControls.classList.remove('hidden');
            rangeCircle.addTo(map);
            centerMarker.addTo(map);
            map.setView([centerLat, centerLng], 8);
        }
    }

    function switchMode() {
        const radios = document.getElementsByName('mode');
        for(let r of radios) { if(r.checked) currentMode = r.value; }
        
        // UI æ›´æ–°
        const btn = document.getElementById('main-btn');
        if(currentMode === 'single') {
            btn.innerText = "ğŸ¯ æŠ½é¸è¡Œæ”¿å€ï¼";
            btn.className = "action-btn";
        } else {
            btn.innerText = "ğŸ² éš¨æ©Ÿè‡ªé§• (èµ·é»/çµ‚é»)";
            btn.className = "action-btn blue";
        }
        clearMap();
    }

    function clearMap() {
        if(destMarker) map.removeLayer(destMarker);
        if(startMarker) map.removeLayer(startMarker);
        if(endMarker) map.removeLayer(endMarker);
        if(routeLine) map.removeLayer(routeLine);
        map.removeLayer(routePolyline);
    }

    // --- æ ¸å¿ƒæ¼”ç®—æ³•ï¼šå¾é™£åˆ—ä¸­ç¯©é¸ ---
    function getRandomCity(isJapanWide) {
        let candidates = [];

        if (isJapanWide) {
            // å…¨æ—¥æœ¬æ¨¡å¼ï¼šç›´æ¥ç”¨æ•´å€‹é™£åˆ—
            candidates = japanCities;
        } else {
            // ç¯„åœæ¨¡å¼ï¼šç¯©é¸åŠå¾‘å…§çš„åŸå¸‚
            candidates = japanCities.filter(city => {
                const dist = map.distance([city[0], city[1]], [centerLat, centerLng]);
                return dist <= radiusKm * 1000;
            });
        }

        if (candidates.length === 0) return null;
        
        // éš¨æ©ŸæŠ½é¸ä¸€å€‹
        const randomIndex = Math.floor(Math.random() * candidates.length);
        const c = candidates[randomIndex];
        return { lat: c[0], lng: c[1], name: c[2] };
    }

    function executeRandom() {
        clearMap();
        document.getElementById('result-display').innerHTML = "ğŸ² æ­£åœ¨å¾è¡Œæ”¿å€åˆ—è¡¨ä¸­æŠ½é¸...";

        setTimeout(() => {
            const isWide = japanWideCheck.checked;
            
            if (currentMode === 'single') {
                // å–®é»æ¨¡å¼
                const city = getRandomCity(isWide);
                
                if (!city) {
                    alert("âš ï¸ æ­¤ç¯„åœå…§æ‰¾ä¸åˆ°è¡Œæ”¿å€è³‡æ–™ï¼\nè«‹æ“´å¤§åŠå¾‘æˆ–ç§»å‹•ä¸­å¿ƒé»ã€‚");
                    document.getElementById('result-display').innerHTML = "âŒ ç¯„åœå…§ç„¡è³‡æ–™";
                    return;
                }

                destMarker = L.marker([city.lat, city.lng], {icon: redIcon}).addTo(map);
                map.flyTo([city.lat, city.lng], isWide ? 10 : 12, {animate:true, duration:1.2});
                
                const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${city.lat},${city.lng}`;
                destMarker.bindPopup(`<b>ğŸ¯ æŠ½é¸çµæœ</b><br>${city.name}<br><a href="${gmapUrl}" target="_blank">Google Maps</a>`).openPopup();

                document.getElementById('result-display').innerHTML = 
                    `<b>ğŸ¯ ç›®çš„åœ°ï¼š${city.name}</b><br>` +
                    `<a href="${gmapUrl}" target="_blank" class="gmap-link">ğŸ“ åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹</a>`;

            } else {
                // è‡ªé§•æ¨¡å¼ (èµ·çµ‚é»)
                const start = getRandomCity(isWide);
                // ç¢ºä¿çµ‚é»è·Ÿèµ·é»ä¸ä¸€æ¨£ (ç°¡å–® retry æ©Ÿåˆ¶)
                let end = getRandomCity(isWide);
                let retry = 0;
                while (start.name === end.name && retry < 5) {
                    end = getRandomCity(isWide);
                    retry++;
                }

                if (!start || !end) {
                    alert("âš ï¸ è³‡æ–™ä¸è¶³ä»¥ç”¢ç”Ÿè·¯å¾‘ï¼Œè«‹æ“´å¤§ç¯„åœã€‚");
                    return;
                }

                startMarker = L.marker([start.lat, start.lng], {icon: greenIcon}).addTo(map);
                endMarker = L.marker([end.lat, end.lng], {icon: redIcon}).addTo(map);
                
                // ç•«ç·š
                routePolyline.setLatLngs([[start.lat, start.lng], [end.lat, end.lng]]).addTo(map);
                map.fitBounds(routePolyline.getBounds().pad(0.2));

                const dist = (map.distance([start.lat, start.lng], [end.lat, end.lng]) / 1000).toFixed(1);
                const gmapUrl = `https://www.google.com/maps/dir/?api=1&origin=${start.lat},${start.lng}&destination=${end.lat},${end.lng}&travelmode=driving`;

                startMarker.bindPopup(`<b>ğŸ èµ·é»</b><br>${start.name}`).openPopup();
                endMarker.bindPopup(`<b>ğŸ çµ‚é»</b><br>${end.name}<br><a href="${gmapUrl}" target="_blank">å°èˆª</a>`);

                document.getElementById('result-display').innerHTML = 
                    `<b>ğŸš— éš¨æ©Ÿè‡ªé§•è·¯å¾‘</b><br>` +
                    `<span style="color:#2ecc71">â—</span> èµ·ï¼š${start.name}<br>` +
                    `<span style="color:#e74c3c">â—</span> çµ‚ï¼š${end.name}<br>` +
                    `ç›´ç·šè·é›¢ï¼š${dist} km<br>` +
                    `<a href="${gmapUrl}" target="_blank" class="gmap-link blue">ğŸ—ºï¸ é–‹å•Ÿ Google å°èˆª</a>`;
            }
        }, 500);
    }

    function togglePanel() {
        const p = document.getElementById('controls');
        const b = document.getElementById('toggle-btn');
        p.classList.toggle('minimized');
        b.innerText = p.classList.contains('minimized') ? 'â˜' : '_';
    }
</script>
</body>
</html>
