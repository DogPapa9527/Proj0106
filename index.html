<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Travel Dart V9.2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "SF Pro TC", "Microsoft JhengHei", sans-serif; -webkit-font-smoothing: antialiased; overflow: hidden;}
        #map { height: 100vh; width: 100%; z-index: 1; background: #aad3df; }
        
        /* --- é€šç”¨é¢æ¿æ¨£å¼ --- */
        .bottom-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 1000; width: 90%; max-width: 380px;
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* éš±è—ç‹€æ…‹ (å®Œå…¨ç§»å‡ºç•«é¢) */
        .panel-hidden { transform: translate(-50%, 150%); opacity: 0; pointer-events: none; }

        /* --- 1. æ§åˆ¶é¢æ¿ (è¨­å®šå€) --- */
        #controls { padding: 20px; }
        
        /* ç¸®å°å¾Œçš„æ§åˆ¶é¢æ¿ */
        #controls.minimized {
            width: 180px; padding: 10px 15px; bottom: 20px;
            border-radius: 30px;
            flex-direction: row; justify-content: space-between; align-items: center;
        }
        /* ç¸®å°å¾Œéš±è—å…§å®¹ */
        #controls.minimized .panel-body { display: none; }
        #controls.minimized .header-row h2 { font-size: 0.9rem; margin: 0; }
        #controls.minimized .toggle-btn { transform: rotate(180deg); }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-row h2 { margin: 0; font-size: 1.1rem; color: #333; }
        .toggle-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #888; padding: 5px; transition: 0.3s; }

        .mode-tabs { display: flex; background: #f0f2f5; border-radius: 10px; padding: 4px; margin-bottom: 15px; }
        .mode-tabs label { flex: 1; text-align: center; padding: 10px 0; cursor: pointer; border-radius: 8px; font-size: 0.9rem; font-weight: bold; color: #888; transition: all 0.2s; }
        .mode-tabs input { display: none; }
        .mode-tabs input:checked + label { background: #fff; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        #distance-control { margin-bottom: 15px; display: none; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.85rem; }
        input[type="range"] { width: 100%; accent-color: #4285f4; cursor: pointer; }

        button.main-btn {
            background-color: #ff5252; color: white; border: none; padding: 14px;
            width: 100%; font-size: 1.05rem; font-weight: 800; border-radius: 12px;
            cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 12px rgba(255, 82, 82, 0.3);
        }
        button.main-btn:active { transform: scale(0.98); }
        button.main-btn.blue { background-color: #4285f4; box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }

        /* --- 2. çµæœé¢æ¿ (Promptå€) --- */
        #result-panel { padding: 0; max-height: 80vh; }
        
        /* çµæœé¢æ¿ - è¿·ä½ æ¨¡å¼ (é è¨­) */
        .result-mini { padding: 20px; }
        .result-title { font-size: 1.2rem; font-weight: 800; color: #333; margin-bottom: 5px; }
        .result-sub { font-size: 0.95rem; color: #666; margin-bottom: 15px; line-height: 1.4; }
        
        .action-row { display: flex; gap: 10px; }
        .btn-outline { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; font-weight: bold; color: #555; cursor: pointer; }
        .btn-fill { flex: 1; padding: 10px; border: none; border-radius: 8px; background: #4285f4; font-weight: bold; color: white; cursor: pointer; text-decoration: none; display: flex; align-items: center; justify-content: center;}
        .btn-ai { flex: 1; padding: 10px; border: none; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3); }

        /* çµæœé¢æ¿ - å±•é–‹æ¨¡å¼ (Prompt) */
        .result-expanded { 
            background: #f8f9fa; border-top: 1px solid #eee; 
            padding: 15px; display: none; /* é è¨­éš±è— */
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .prompt-box { background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .prompt-label { font-size: 0.75rem; color: #888; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        textarea#gemini-prompt { width: 100%; height: 100px; border: none; resize: none; outline: none; font-size: 0.9rem; color: #333; font-family: monospace; }
        
        .close-result-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #999; cursor: pointer; line-height: 1; z-index: 2;}

        /* Leaflet Popups */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 8px; padding: 5px; }
        .custom-popup .leaflet-popup-content { margin: 10px; font-size: 0.9rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="controls" class="bottom-panel">
        <div class="header-row">
            <h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠå°„é£›é¢</h2>
            <button class="toggle-btn" onclick="toggleControls()">_</button>
        </div>
        
        <div class="panel-body">
            <div class="mode-tabs">
                <input type="radio" id="mode-single" name="mode" value="single" checked onchange="switchMode()">
                <label for="mode-single">ğŸ¯ å–®é»æ—…éŠ</label>
                
                <input type="radio" id="mode-route" name="mode" value="route" onchange="switchMode()">
                <label for="mode-route">ğŸš— è‡ªé§•æ—…ç¨‹</label>
            </div>

            <div id="distance-control">
                <div class="slider-label">
                    <span>æ—…ç¨‹è·é›¢ (ç›´ç·š)</span>
                    <span id="dist-val">150 km</span>
                </div>
                <input type="range" id="dist-slider" min="50" max="500" step="50" value="150" oninput="updateDistLabel(this.value)">
            </div>

            <button id="main-btn" class="main-btn" onclick="execute()">ğŸ² éš¨æ©Ÿæ±ºå®šï¼</button>
        </div>
    </div>

    <div id="result-panel" class="bottom-panel panel-hidden">
        <div class="close-result-btn" onclick="resetToControls()">Ã—</div>
        
        <div class="result-mini">
            <div id="res-title" class="result-title">åœ°é»è¼‰å…¥ä¸­...</div>
            <div id="res-sub" class="result-sub"></div>
            
            <div class="action-row">
                <a id="btn-gmap" href="#" target="_blank" class="btn-fill">ğŸ—ºï¸ Google Maps</a>
                <button id="btn-expand" class="btn-ai" onclick="togglePrompt()">âœ¨ AI è¦åŠƒ</button>
            </div>
        </div>

        <div id="prompt-area" class="result-expanded">
            <div class="prompt-box">
                <div class="prompt-label">Gemini AI Prompt (å¯è¤‡è£½)</div>
                <textarea id="gemini-prompt" readonly onclick="this.select()"></textarea>
            </div>
            <button class="btn-outline" style="width:100%" onclick="copyPrompt()">ğŸ“‹ è¤‡è£½ Prompt</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // è³‡æ–™åº« (æ¨¡æ“¬å…§å»º)
        const japanCities = [
             [43.062,141.354,"åŒ—æµ·é“ æœ­å¹Œå¸‚"],[41.768,140.728,"åŒ—æµ·é“ å‡½é¤¨å¸‚"],[43.770,142.364,"åŒ—æµ·é“ æ—­å·å¸‚"],[45.415,141.673,"åŒ—æµ·é“ ç¨šå…§å¸‚"],[43.190,140.994,"åŒ—æµ·é“ å°æ¨½å¸‚"],[42.320,140.970,"åŒ—æµ·é“ ç™»åˆ¥å¸‚"],
            [40.824,140.740,"é’æ£®ç¸£ é’æ£®å¸‚"],[38.268,140.869,"å®®åŸç¸£ ä»™å°å¸‚"],[38.255,140.339,"å±±å½¢ç¸£ å±±å½¢å¸‚"],[37.494,139.929,"ç¦å³¶ç¸£ æœƒæ´¥è‹¥æ¾å¸‚"],
            [36.719,139.698,"æ ƒæœ¨ç¸£ æ—¥å…‰å¸‚"],[36.341,138.633,"é•·é‡ç¸£ è¼•äº•æ¾¤"],[35.925,139.485,"åŸ¼ç‰ç¸£ å·è¶Šå¸‚"],[35.689,139.691,"æ±äº¬éƒ½ æ–°å®¿å€"],[35.250,139.053,"ç¥å¥ˆå·ç¸£ ç®±æ ¹ç”º"],
            [36.578,136.648,"çŸ³å·ç¸£ é‡‘æ¾¤å¸‚"],[36.275,136.897,"å²é˜œç¸£ ç™½å·é„‰"],[35.496,138.743,"å±±æ¢¨ç¸£ æ²³å£æ¹–"],[35.181,136.906,"æ„›çŸ¥ç¸£ åå¤å±‹å¸‚"],
            [35.011,135.768,"äº¬éƒ½åºœ äº¬éƒ½å¸‚"],[34.693,135.502,"å¤§é˜ªåºœ å¤§é˜ªå¸‚"],[34.690,135.195,"å…µåº«ç¸£ ç¥æˆ¶å¸‚"],[34.685,135.804,"å¥ˆè‰¯ç¸£ å¥ˆè‰¯å¸‚"],
            [34.385,132.455,"å»£å³¶ç¸£ å»£å³¶å¸‚"],[34.342,134.043,"é¦™å·ç¸£ é«˜æ¾å¸‚"],[33.841,132.765,"æ„›åª›ç¸£ æ¾å±±å¸‚"],
            [33.590,130.401,"ç¦å²¡ç¸£ ç¦å²¡å¸‚"],[33.279,131.505,"å¤§åˆ†ç¸£ åˆ¥åºœå¸‚"],[32.794,130.707,"ç†Šæœ¬ç¸£ ç†Šæœ¬å¸‚"],[31.596,130.557,"é¹¿å…’å³¶ç¸£ é¹¿å…’å³¶å¸‚"],
            [26.212,127.680,"æ²–ç¹©ç¸£ é‚£éœ¸å¸‚"],[24.344,124.157,"æ²–ç¹©ç¸£ çŸ³å£å³¶"]
        ];

        // åˆå§‹åŒ–åœ°åœ–
        const map = L.map('map', {zoomControl: false}).setView([38.0, 137.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: ''}).addTo(map);

        let currentMode = 'single';
        let markers = [];
        let polyline = null;
        let isPromptExpanded = false;

        // Icons
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- UI æ§åˆ¶é‚è¼¯ ---

        // 1. æ§åˆ¶é¢æ¿ç¸®æ”¾
        function toggleControls() {
            const panel = document.getElementById('controls');
            const btn = panel.querySelector('.toggle-btn');
            panel.classList.toggle('minimized');
            btn.innerText = panel.classList.contains('minimized') ? 'â˜' : '_';
        }

        // 2. çµæœé¢æ¿ Prompt å±•é–‹/æ”¶åˆ
        function togglePrompt() {
            const area = document.getElementById('prompt-area');
            const btn = document.getElementById('btn-expand');
            
            if (isPromptExpanded) {
                area.style.display = 'none';
                btn.innerText = "âœ¨ AI è¦åŠƒ";
                isPromptExpanded = false;
            } else {
                area.style.display = 'block';
                btn.innerText = "ğŸ”¼ æ”¶èµ· Prompt";
                isPromptExpanded = true;
            }
        }

        // 3. é‡ç½®å›æ§åˆ¶é¢æ¿ (é—œé–‰çµæœ)
        function resetToControls() {
            // éš±è—çµæœé¢æ¿
            document.getElementById('result-panel').classList.add('panel-hidden');
            // é¡¯ç¤ºæ§åˆ¶é¢æ¿
            document.getElementById('controls').classList.remove('panel-hidden');
            // æ¸…é™¤åœ°åœ–
            clearMap();
            // é‡ç½® Prompt ç‹€æ…‹
            document.getElementById('prompt-area').style.display = 'none';
            document.getElementById('btn-expand').innerText = "âœ¨ AI è¦åŠƒ";
            isPromptExpanded = false;
        }

        function updateDistLabel(val) {
            document.getElementById('dist-val').innerText = val + " km";
        }

        function switchMode() {
            const radios = document.getElementsByName('mode');
            for(let r of radios) { if(r.checked) currentMode = r.value; }
            
            const btn = document.getElementById('main-btn');
            const slider = document.getElementById('distance-control');
            
            if(currentMode === 'single') {
                btn.innerText = "ğŸ¯ éš¨æ©Ÿå»å“ªå…’ï¼Ÿ";
                btn.className = "main-btn";
                slider.style.display = "none";
            } else {
                btn.innerText = "ğŸš— ç”Ÿæˆè‡ªé§•æ—…ç¨‹";
                btn.className = "main-btn blue";
                slider.style.display = "block";
            }
        }

        function clearMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if(polyline) map.removeLayer(polyline);
        }

        function execute() {
            clearMap();
            
            // 1. éš±è—æ§åˆ¶é¢æ¿
            document.getElementById('controls').classList.add('panel-hidden');
            
            setTimeout(() => {
                if(currentMode === 'single') {
                    const city = japanCities[Math.floor(Math.random() * japanCities.length)];
                    showSingleResult(city);
                } else {
                    const distTarget = parseInt(document.getElementById('dist-slider').value);
                    generateRoute(distTarget);
                }
            }, 300);
        }

        function generateRoute(targetDist) {
            let start, end, found = false, attempts = 0;
            while(!found && attempts < 100) {
                attempts++;
                start = japanCities[Math.floor(Math.random() * japanCities.length)];
                const candidates = japanCities.filter(c => {
                    if(c[2] === start[2]) return false;
                    const d = map.distance([start[0],start[1]], [c[0],c[1]]) / 1000;
                    return d > targetDist * 0.7 && d < targetDist * 1.3;
                });
                if(candidates.length > 0) {
                    end = candidates[Math.floor(Math.random() * candidates.length)];
                    found = true;
                }
            }
            if(!found) {
                alert("æ‰¾ä¸åˆ°åˆé©è·é›¢è·¯å¾‘ï¼Œè«‹é‡è©¦ï¼");
                resetToControls();
                return;
            }
            showRouteResult(start, end);
        }

        // --- çµæœé¡¯ç¤º ---
        function showSingleResult(city) {
            const m = L.marker([city[0], city[1]], {icon: redIcon}).addTo(map);
            markers.push(m);
            map.flyTo([city[0], city[1]], 10, {animate:true, duration: 1});

            const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${city[2]}`;
            const prompt = `æˆ‘éš¨æ©ŸæŠ½é¸åˆ°äº†åœ°é»ï¼šã€${city[2]}ã€‘ã€‚è«‹å¹«æˆ‘è¦åŠƒ 4 å¤© 3 å¤œè¡Œç¨‹ï¼ŒåŒ…å«ç§æˆ¿æ™¯é»ã€ç¾é£Ÿã€ä½å®¿å»ºè­°ã€‚`;

            updateResultPanel(
                `ğŸ¯ ç›®çš„åœ°ï¼š${city[2]}`, 
                "å–®é»æ¼«éŠ", 
                prompt, gmapUrl
            );
        }

        function showRouteResult(start, end) {
            const m1 = L.marker([start[0], start[1]], {icon: greenIcon}).addTo(map);
            const m2 = L.marker([end[0], end[1]], {icon: redIcon}).addTo(map);
            markers.push(m1, m2);

            const line = L.polyline([[start[0], start[1]], [end[0], end[1]]], {color: '#4285f4', weight: 5, opacity: 0.8, dashArray: '10,10'}).addTo(map);
            polyline = line;
            map.fitBounds(line.getBounds().pad(0.3));

            const dist = (map.distance([start[0],start[1]], [end[0],end[1]]) / 1000).toFixed(0);
            const gmapUrl = `https://www.google.com/maps/dir/?api=1&origin=${start[0]},${start[1]}&destination=${end[0]},${end[1]}&travelmode=driving`;
            
            const prompt = `è‡ªé§•è¦åŠƒï¼šèµ·é»ã€${start[2]}ã€‘åˆ°çµ‚é»ã€${end[2]}ã€‘ï¼Œè·é›¢ç´„ ${dist} kmã€‚è«‹è¦åŠƒç§Ÿè»Šã€ä¸­é€”æ™¯é»ã€ä½å®¿åŠè·¯ç·šå»ºè­°ã€‚`;

            updateResultPanel(
                `ğŸš— è‡ªé§•ï¼š${start[2]} â®• ${end[2]}`, 
                `ç›´ç·šè·é›¢ç´„ ${dist} å…¬é‡Œ`, 
                prompt, gmapUrl
            );
        }

        function updateResultPanel(title, sub, promptText, gmapUrl) {
            // å¡«å…¥è³‡æ–™
            document.getElementById('res-title').innerText = title;
            document.getElementById('res-sub').innerText = sub;
            document.getElementById('gemini-prompt').value = promptText;
            document.getElementById('btn-gmap').href = gmapUrl;

            // é¡¯ç¤ºçµæœé¢æ¿ (é è¨­ Mini ç‹€æ…‹)
            document.getElementById('result-panel').classList.remove('panel-hidden');
            
            // ç¢ºä¿ Prompt å€åŸŸæ˜¯æ”¶èµ·çš„
            document.getElementById('prompt-area').style.display = 'none';
            document.getElementById('btn-expand').innerText = "âœ¨ AI è¦åŠƒ";
            isPromptExpanded = false;
        }

        function copyPrompt() {
            const box = document.getElementById('gemini-prompt');
            box.select();
            navigator.clipboard.writeText(box.value);
            alert("å·²è¤‡è£½ Promptï¼");
        }
    </script>
</body>
</html>
