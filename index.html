<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ—…éŠå°„é£›é¢ - é™¸åœ°å„ªåŒ–ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        /* é¿å…ç°åº•ï¼Œè¨­å®šä¸€å€‹æµ·çš„é¡è‰²ç•¶é è¨­èƒŒæ™¯ */
        #map { height: 100vh; width: 100%; z-index: 1; background: #aad3df; }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 300px;
        }
        h2 { margin-top: 0; font-size: 1.2rem; color: #333; border-bottom: 2px solid #ff5252; padding-bottom: 5px; }
        
        .control-group { margin-bottom: 15px; }
        .checkbox-group {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .checkbox-group input { margin-right: 10px; transform: scale(1.2); }
        .checkbox-group label { cursor: pointer; font-weight: bold; font-size: 0.95rem; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="range"] { width: 100%; }
        
        /* ç¦ç”¨ç‹€æ…‹ */
        .disabled { opacity: 0.4; pointer-events: none; }

        button {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 12px 20px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #d32f2f; }
        
        #result-display {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }
        a.gmap-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠå°„é£›é¢</h2>
        
        <div class="control-group checkbox-group">
            <input type="checkbox" id="japan-wide-check">
            <label for="japan-wide-check">ğŸ—¾ éš¨æ©ŸæŒ‘æˆ°å…¨æ—¥æœ¬ (é™¸åœ°å„ªå…ˆ)</label>
        </div>

        <div id="circle-controls">
            <div class="control-group">
                <label>ç¯„åœåŠå¾‘: <span id="radius-val">100</span> km</label>
                <input type="range" id="radius-slider" min="10" max="1000" value="100" step="10">
            </div>
            <p style="font-size: 0.8rem; color: #666;">ğŸ’¡ æ‹–æ›³åœ°åœ–ä¸Šçš„è—è‰²æ¨™è¨˜ä¾†æ”¹è®Šä¸­å¿ƒé»</p>
        </div>

        <button onclick="throwDart()">ğŸ¯ å°„å‡ºé£›é¢ï¼</button>
        
        <div id="result-display">æº–å‚™å¥½é–‹å§‹äº†å—ï¼Ÿ</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. åˆå§‹åŒ–åœ°åœ– (ä½¿ç”¨ OpenStreetMap åŸç”Ÿåœ–è³‡ï¼ŒåŒç¬¬ä¸€ç‰ˆ)
        const map = L.map('map').setView([35.6895, 139.6917], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // 2. è®Šæ•¸è¨­å®š
        let centerLat = 35.6895; // æ±äº¬
        let centerLng = 139.6917;
        let radiusKm = 100;
        let resultMarker = null;

        // UI å…ƒç´ 
        const japanWideCheck = document.getElementById('japan-wide-check');
        const circleControls = document.getElementById('circle-controls');
        const slider = document.getElementById('radius-slider');
        const radiusDisplay = document.getElementById('radius-val');

        // 3. å»ºç«‹åœ“å½¢æ¨¡å¼å…ƒä»¶
        const centerMarker = L.marker([centerLat, centerLng], {draggable: true}).addTo(map);
        centerMarker.bindPopup("å‡ºç™¼ä¸­å¿ƒé» (æ‹–æ›³æˆ‘)").openPopup();

        const rangeCircle = L.circle([centerLat, centerLng], {
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.1,
            radius: radiusKm * 1000
        }).addTo(map);

        // 4. äº‹ä»¶ç›£è½
        japanWideCheck.onchange = function() {
            if (this.checked) {
                // åˆ‡æ›åˆ°å…¨æ—¥æœ¬æ¨¡å¼
                circleControls.classList.add('disabled');
                map.removeLayer(rangeCircle);
                map.removeLayer(centerMarker);
                map.setView([37.0, 138.0], 5); // è¦–é‡æ‹‰é çœ‹å…¨æ—¥æœ¬
            } else {
                // åˆ‡æ›å›åœ“åœˆæ¨¡å¼
                circleControls.classList.remove('disabled');
                rangeCircle.addTo(map);
                centerMarker.addTo(map);
                map.setView([centerLat, centerLng], 8);
            }
        };

        centerMarker.on('drag', function(e) {
            const newPos = e.target.getLatLng();
            centerLat = newPos.lat;
            centerLng = newPos.lng;
            rangeCircle.setLatLng(newPos);
        });

        slider.oninput = function() {
            radiusKm = parseInt(this.value);
            radiusDisplay.innerText = radiusKm;
            rangeCircle.setRadius(radiusKm * 1000);
        };

        // 5. æ ¸å¿ƒé‚è¼¯ï¼šé¿é–‹æµ·æ´‹çš„å€åŸŸå®šç¾©
        // ç‚ºäº†ä¸ä¾è³´é¾œé€Ÿçš„ APIï¼Œæˆ‘å€‘å®šç¾©å¹¾å€‹çŸ©å½¢ï¼Œç›¡é‡è²¼åˆæ—¥æœ¬é™¸åœ°å½¢ç‹€
        const japanZones = [
            { name: "åŒ—æµ·é“", minLat: 41.5, maxLat: 45.3, minLng: 140.0, maxLng: 145.5, weight: 2 },
            { name: "æ±åŒ—åœ°å€", minLat: 37.0, maxLat: 41.5, minLng: 139.5, maxLng: 141.5, weight: 2 },
            { name: "é—œæ±/ä¸­éƒ¨", minLat: 34.8, maxLat: 37.0, minLng: 137.0, maxLng: 140.5, weight: 3 }, // æ±äº¬ã€åå¤å±‹
            { name: "é—œè¥¿/å››åœ‹", minLat: 33.0, maxLat: 35.5, minLng: 132.5, maxLng: 136.0, weight: 2 }, // å¤§é˜ªã€å››åœ‹
            { name: "ä¸­åœ‹/ä¹å·", minLat: 31.0, maxLat: 34.5, minLng: 129.5, maxLng: 132.5, weight: 2 }, // å»£å³¶ã€ç¦å²¡
            { name: "æ²–ç¹©", minLat: 26.0, maxLat: 27.0, minLng: 127.5, maxLng: 128.3, weight: 0.5 }    // æ²–ç¹©æœ¬å³¶
        ];

        function getRandomPointInJapan() {
            // æ¬Šé‡éš¨æ©Ÿç®—æ³•ï¼šæ ¹æ“š weight æ±ºå®šæ‰åœ¨å“ªå€‹å€åŸŸ (äººå£å¯†é›†æˆ–é™¸åœ°å¤§çš„åœ°æ–¹æ¬Šé‡é«˜)
            const totalWeight = japanZones.reduce((sum, zone) => sum + zone.weight, 0);
            let random = Math.random() * totalWeight;
            
            let selectedZone = japanZones[0];
            for (let zone of japanZones) {
                if (random < zone.weight) {
                    selectedZone = zone;
                    break;
                }
                random -= zone.weight;
            }

            // åœ¨é¸å®šå€åŸŸå…§éš¨æ©Ÿ
            const lat = Math.random() * (selectedZone.maxLat - selectedZone.minLat) + selectedZone.minLat;
            const lng = Math.random() * (selectedZone.maxLng - selectedZone.minLng) + selectedZone.minLng;
            
            return { lat, lng, zoneName: selectedZone.name };
        }

        // 6. å°„é£›é¢ä¸»ç¨‹å¼
        function throwDart() {
            if (resultMarker) map.removeLayer(resultMarker);
            document.getElementById('result-display').innerHTML = "ğŸš€ é£›é¢é£›è¡Œä¸­...";

            let targetLat, targetLng;
            let debugInfo = "";

            if (japanWideCheck.checked) {
                // ä½¿ç”¨æ–°çš„ã€Œåˆ†å€éš¨æ©Ÿã€ç®—æ³•ï¼Œå¤§å¹…é™ä½è½æµ·æ©Ÿç‡
                const point = getRandomPointInJapan();
                targetLat = point.lat;
                targetLng = point.lng;
                debugInfo = `(å€åŸŸ: ${point.zoneName})`;
            } else {
                // åœ“å½¢ç¯„åœ (åŸç®—æ³•)
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.sqrt(Math.random()) * radiusKm;
                const earthRadius = 6371;
                const deltaLat = (distance * Math.cos(angle) / earthRadius) * (180 / Math.PI);
                const deltaLng = (distance * Math.sin(angle) / (earthRadius * Math.cos(centerLat * Math.PI / 180))) * (180 / Math.PI);
                targetLat = centerLat + deltaLat;
                targetLng = centerLng + deltaLng;
                debugInfo = `(è·é›¢: ${distance.toFixed(1)} km)`;
            }

            // æ¨¡æ“¬å‹•ç•«å»¶é²
            setTimeout(() => {
                const redIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                resultMarker = L.marker([targetLat, targetLng], {icon: redIcon}).addTo(map);
                
                // é£›éå»
                map.flyTo([targetLat, targetLng], japanWideCheck.checked ? 10 : 12, {
                    animate: true,
                    duration: 1.5
                });

                // Google Maps é€£çµ (ä½¿ç”¨ HTTPS API)
                const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${targetLat},${targetLng}`;

                const popupContent = `<b>å‘½ä¸­ï¼</b><br><a href="${gmapUrl}" target="_blank" class="gmap-link">åœ¨ Google Maps é–‹å•Ÿ</a>`;
                resultMarker.bindPopup(popupContent).openPopup();

                document.getElementById('result-display').innerHTML = 
                    `ğŸ“ åº§æ¨™: ${targetLat.toFixed(4)}, ${targetLng.toFixed(4)} <br>` +
                    `<span style="color:#888; font-size:0.8em;">${debugInfo}</span><br>` +
                    `<a href="${gmapUrl}" target="_blank" class="gmap-link">ğŸ‘‰ åœ¨ Google Maps æŸ¥çœ‹</a>`;

            }, 500);
        }
    </script>
</body>
</html>
