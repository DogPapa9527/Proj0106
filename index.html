<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬éš¨æ©Ÿæ—…éŠ V7</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #aad3df; }
        
        /* é¢æ¿æ¨£å¼ */
        #controls {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 310px;
            transition: all 0.3s ease;
            max-height: 85vh; overflow-y: auto;
        }

        #controls.minimized { width: 160px; padding-bottom: 5px; }
        #controls.minimized #panel-content { display: none; }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 3px solid #ff5252; padding-bottom: 8px;
        }
        h2 { margin: 0; font-size: 1.1rem; color: #333; }
        #toggle-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #555; }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-switcher {
            display: flex; background: #eee; border-radius: 8px; padding: 4px; margin-bottom: 15px;
        }
        .mode-switcher label {
            flex: 1; text-align: center; padding: 10px 0; cursor: pointer;
            border-radius: 6px; font-size: 0.9rem; color: #666; font-weight: bold; transition: all 0.2s;
        }
        .mode-switcher input { display: none; }
        .mode-switcher input:checked + label {
            background: #fff; color: #ff5252; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-group { margin-bottom: 15px; }
        .checkbox-group {
            background: #f8f9fa; padding: 10px; border-radius: 5px;
            display: flex; align-items: center;
        }
        .checkbox-group input { margin-right: 10px; transform: scale(1.2); }
        .checkbox-group label { margin: 0; cursor: pointer; font-size: 0.9rem; font-weight: bold;}

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none !important; }

        button.action-btn {
            background-color: #ff5252; color: white; border: none; padding: 14px;
            width: 100%; font-size: 1rem; font-weight: bold; border-radius: 8px;
            cursor: pointer; transition: background 0.2s;
            box-shadow: 0 4px 6px rgba(255,82,82,0.3);
        }
        button.action-btn:hover { background-color: #d32f2f; }
        
        /* è—è‰²æŒ‰éˆ• (è‡ªé§•æ¨¡å¼ç”¨) */
        button.action-btn.blue { background-color: #4285f4; box-shadow: 0 4px 6px rgba(66,133,244,0.3); }
        button.action-btn.blue:hover { background-color: #3367d6; }

        #result-display {
            margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;
            font-size: 0.9rem; color: #555; line-height: 1.5;
        }
        a.gmap-link {
            color: white; background: #d93025; padding: 6px 12px;
            border-radius: 4px; text-decoration: none; font-weight: bold;
            display: inline-block; margin-top: 8px; font-size: 0.9rem;
        }
        a.gmap-link.blue { background: #4285f4; }
    </style>
</head>
<body>

    <div id="controls">
        <div class="header-bar">
            <h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬éš¨æ©Ÿæ—…éŠ V7</h2>
            <button id="toggle-btn" onclick="togglePanel()">_</button>
        </div>

        <div id="panel-content">
            <div class="mode-switcher">
                <input type="radio" id="mode-single" name="mode" value="single" checked onchange="switchMode()">
                <label for="mode-single">ğŸ¯ å–®é»å†’éšª</label>
                
                <input type="radio" id="mode-route" name="mode" value="route" onchange="switchMode()">
                <label for="mode-route">ğŸš— éš¨æ©Ÿè‡ªé§•</label>
            </div>

            <div class="control-group checkbox-group">
                <input type="checkbox" id="japan-wide-check">
                <label for="japan-wide-check">ğŸ—¾ å…¨æ—¥æœ¬ç¯„åœ (é™¸åœ°)</label>
            </div>
            
            <div id="circle-controls">
                <div class="control-group">
                    <label style="display:block;margin-bottom:5px;font-weight:bold;">åŠå¾‘: <span id="radius-val">100</span> km</label>
                    <input type="range" id="radius-slider" min="10" max="1000" value="100" step="10">
                </div>
                <p style="font-size: 0.8rem; color: #666; margin-top:0;">
                    ğŸ’¡ æ‹–æ›³åœ°åœ–ä¸Šçš„ <b id="drag-hint">è—è‰²æ¨™è¨˜</b> è¨­å®šä¸­å¿ƒ
                </p>
            </div>

            <button id="main-btn" class="action-btn" onclick="executeRandom()">ğŸ¯ å°„å‡ºé£›é¢ï¼</button>
            
            <div id="result-display">æº–å‚™å¥½è¦è©¦æ‰‹æ°£äº†å—ï¼Ÿ</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. åˆå§‹åŒ–åœ°åœ– ---
        const map = L.map('map').setView([35.6895, 139.6917], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // --- 2. è®Šæ•¸èˆ‡å…ƒä»¶ ---
        let currentMode = 'single';
        let centerLat = 35.6895; 
        let centerLng = 139.6917;
        let radiusKm = 100;

        // åœ–å±¤ç‰©ä»¶
        let centerMarker = null; // ç¯„åœä¸­å¿ƒé» (è—)
        let rangeCircle = null;  // ç¯„åœåœ“åœˆ
        let destMarker = null;   // å–®é»æ¨¡å¼çµæœ (ç´…)
        let startMarker = null;  // è‡ªé§•æ¨¡å¼èµ·é» (ç¶ )
        let endMarker = null;    // è‡ªé§•æ¨¡å¼çµ‚é» (ç´…)
        let routeLine = null;    // é€£æ¥ç·š

        // UI åƒè€ƒ
        const japanWideCheck = document.getElementById('japan-wide-check');
        const circleControls = document.getElementById('circle-controls');
        const slider = document.getElementById('radius-slider');
        const radiusDisplay = document.getElementById('radius-val');
        const mainBtn = document.getElementById('main-btn');
        const dragHint = document.getElementById('drag-hint');

        // åœ–æ¨™
        const blueIcon = new L.Icon.Default(); // é è¨­è—è‰²
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- 3. ç³»çµ±åˆå§‹åŒ– ---
        initMapObjects();

        function initMapObjects() {
            // å»ºç«‹ä¸­å¿ƒé» (è—è‰² - ç”¨æ–¼è¨­å®šåœ“å½¢ç¯„åœ)
            centerMarker = L.marker([centerLat, centerLng], {draggable: true}).addTo(map);
            centerMarker.bindPopup("ç¯„åœä¸­å¿ƒé» (æ‹–æ›³æˆ‘)").openPopup();

            // å»ºç«‹åœ“åœˆ
            rangeCircle = L.circle([centerLat, centerLng], {
                color: '#3388ff', fillColor: '#3388ff', fillOpacity: 0.1, radius: radiusKm * 1000
            }).addTo(map);

            // å»ºç«‹é€£ç·š (é è¨­éš±è—)
            routeLine = L.polyline([], {color: '#4285f4', weight: 4, opacity: 0.7, dashArray: '10, 10'});

            // æ‹–æ›³ç›£è½
            centerMarker.on('drag', (e) => {
                const pos = e.target.getLatLng();
                centerLat = pos.lat;
                centerLng = pos.lng;
                rangeCircle.setLatLng(pos);
            });
        }

        // --- 4. æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
        function switchMode() {
            const radios = document.getElementsByName('mode');
            for(let r of radios) { if(r.checked) currentMode = r.value; }

            clearResults(); // æ¸…é™¤ä¸Šä¸€å ´çš„çµæœ

            if (currentMode === 'single') {
                // å–®é»æ¨¡å¼ UI
                mainBtn.innerText = "ğŸ¯ å°„å‡ºé£›é¢ï¼";
                mainBtn.className = "action-btn"; // ç´…è‰²
                dragHint.style.color = "#3388ff"; // è—å­—
                document.getElementById('result-display').innerHTML = "å–®é»æ¨¡å¼ï¼šæ±ºå®šä¸€å€‹æ—…éŠåœ°é»";
            } else {
                // è‡ªé§•æ¨¡å¼ UI
                mainBtn.innerText = "ğŸ² éš¨æ©ŸæŠ½å–èµ·é»èˆ‡çµ‚é»";
                mainBtn.className = "action-btn blue"; // è—è‰²
                dragHint.style.color = "#3388ff"; 
                document.getElementById('result-display').innerHTML = "è‡ªé§•æ¨¡å¼ï¼šé›»è…¦å°‡éš¨æ©Ÿæ±ºå®šä¸€åˆ‡";
            }
        }

        // --- 5. éš¨æ©Ÿåº§æ¨™æ¼”ç®—æ³• (æ—¥æœ¬é¿æµ·ç‰ˆ) ---
        const japanZones = [
            { name: "åŒ—æµ·é“", minLat: 41.5, maxLat: 45.3, minLng: 140.0, maxLng: 145.5, weight: 2 },
            { name: "æ±åŒ—", minLat: 37.0, maxLat: 41.5, minLng: 139.5, maxLng: 141.5, weight: 2 },
            { name: "é—œæ±ä¸­éƒ¨", minLat: 34.8, maxLat: 37.0, minLng: 137.0, maxLng: 140.5, weight: 3 },
            { name: "é—œè¥¿å››åœ‹", minLat: 33.0, maxLat: 35.5, minLng: 132.5, maxLng: 136.0, weight: 2 },
            { name: "ä¹å·", minLat: 31.0, maxLat: 34.5, minLng: 129.5, maxLng: 132.5, weight: 2 },
            { name: "æ²–ç¹©", minLat: 26.0, maxLat: 27.0, minLng: 127.5, maxLng: 128.3, weight: 0.5 }
        ];

        function generateRandomPoint() {
            let lat, lng, name;
            
            if (japanWideCheck.checked) {
                // å…¨æ—¥æœ¬æ¨¡å¼ï¼šä½¿ç”¨æ¬Šé‡åˆ†å€
                const totalWeight = japanZones.reduce((sum, zone) => sum + zone.weight, 0);
                let random = Math.random() * totalWeight;
                let zone = japanZones[0];
                for (let z of japanZones) {
                    if (random < z.weight) { zone = z; break; }
                    random -= z.weight;
                }
                lat = Math.random() * (zone.maxLat - zone.minLat) + zone.minLat;
                lng = Math.random() * (zone.maxLng - zone.minLng) + zone.minLng;
                name = zone.name;
            } else {
                // åœ“å½¢ç¯„åœæ¨¡å¼ï¼šæ•¸å­¸è¨ˆç®—
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.sqrt(Math.random()) * radiusKm;
                const earthR = 6371;
                const dLat = (dist * Math.cos(angle) / earthR) * (180 / Math.PI);
                const dLng = (dist * Math.sin(angle) / (earthR * Math.cos(centerLat * Math.PI / 180))) * (180 / Math.PI);
                lat = centerLat + dLat;
                lng = centerLng + dLng;
                name = `ç¯„åœå…§ ${dist.toFixed(1)}km`;
            }
            return { lat, lng, name };
        }

        // --- 6. åŸ·è¡Œä¸»ç¨‹å¼ ---
        function executeRandom() {
            clearResults(); // å…ˆæ¸…é™¤åœ°åœ–ä¸Šçš„æ¨™è¨˜
            document.getElementById('result-display').innerHTML = "ğŸ² è¨ˆç®—ä¸­...";

            setTimeout(() => {
                if (currentMode === 'single') {
                    runSingleMode();
                } else {
                    runRouteMode();
                }
            }, 400); // å°å»¶é²æ¨¡æ“¬è¨ˆç®—æ„Ÿ
        }

        // A. å–®é»æ¨¡å¼é‚è¼¯
        function runSingleMode() {
            const p = generateRandomPoint();
            
            // å»ºç«‹ç´…è‰²æ¨™è¨˜
            destMarker = L.marker([p.lat, p.lng], {icon: redIcon}).addTo(map);
            
            // åœ°åœ–é£›éå»
            map.flyTo([p.lat, p.lng], japanWideCheck.checked ? 10 : 12, {animate: true, duration: 1.2});

            // Google Link
            const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`;
            
            // Popup
            destMarker.bindPopup(`<b>ğŸ¯ ç›®çš„åœ°ï¼</b><br>${p.name}<br><a href="${gmapUrl}" target="_blank">åœ¨ Google Maps é–‹å•Ÿ</a>`).openPopup();

            // Panel Info
            document.getElementById('result-display').innerHTML = 
                `<b>ğŸ¯ å–®é»çµæœï¼š</b><br>åº§æ¨™: ${p.lat.toFixed(3)}, ${p.lng.toFixed(3)}<br>` + 
                `<span style="font-size:0.8em;color:#666">(${p.name})</span><br>` +
                `<a href="${gmapUrl}" target="_blank" class="gmap-link">ğŸ“ æŸ¥çœ‹åœ°åœ–ä½ç½®</a>`;
        }

        // B. è‡ªé§•æ¨¡å¼é‚è¼¯ (éš¨æ©Ÿ Start + éš¨æ©Ÿ End)
        function runRouteMode() {
            // ç”¢ç”Ÿå…©å€‹éš¨æ©Ÿé»
            const startP = generateRandomPoint();
            const endP = generateRandomPoint();

            // å»ºç«‹èµ·é» (ç¶ ) èˆ‡ çµ‚é» (ç´…)
            startMarker = L.marker([startP.lat, startP.lng], {icon: greenIcon}).addTo(map);
            endMarker = L.marker([endP.lat, endP.lng], {icon: redIcon}).addTo(map);

            // ç•«ç·š
            routeLine.setLatLngs([[startP.lat, startP.lng], [endP.lat, endP.lng]]).addTo(map);

            // ç¸®æ”¾åœ°åœ–ä»¥é¡¯ç¤ºæ•´æ¢è·¯å¾‘
            const group = new L.featureGroup([startMarker, endMarker]);
            map.fitBounds(group.getBounds().pad(0.2));

            // è¨ˆç®—ç›´ç·šè·é›¢
            const dist = (map.distance([startP.lat, startP.lng], [endP.lat, endP.lng]) / 1000).toFixed(1);

            // Google Nav Link
            const gmapUrl = `https://www.google.com/maps/dir/?api=1&origin=${startP.lat},${startP.lng}&destination=${endP.lat},${endP.lng}&travelmode=driving`;

            // Popup
            startMarker.bindPopup(`<b>ğŸ èµ·é»</b><br>${startP.name}`).openPopup();
            endMarker.bindPopup(`<b>ğŸ çµ‚é»</b><br>${endP.name}<br><a href="${gmapUrl}" target="_blank">å°èˆªå»é€™è£¡</a>`);

            // Panel Info
            document.getElementById('result-display').innerHTML = 
                `<b>ğŸš— éš¨æ©Ÿè‡ªé§•è·¯ç·šï¼š</b><br>` +
                `<span style="color:#2ecc71">â—</span> èµ·: ${startP.name}<br>` + 
                `<span style="color:#e74c3c">â—</span> çµ‚: ${endP.name}<br>` +
                `ç›´ç·šè·é›¢: ${dist} km<br>` +
                `<a href="${gmapUrl}" target="_blank" class="gmap-link blue">ğŸ—ºï¸ é–‹å•Ÿ Google å°èˆªè·¯ç·š</a>`;
        }

        function clearResults() {
            if (destMarker) map.removeLayer(destMarker);
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeLine) map.removeLayer(routeLine);
        }

        // --- å…¶ä»– UI äº‹ä»¶ ---
        japanWideCheck.onchange = function() {
            if (this.checked) {
                circleControls.classList.add('hidden');
                map.removeLayer(rangeCircle);
                map.removeLayer(centerMarker);
                map.setView([38.0, 137.0], 5);
            } else {
                circleControls.classList.remove('hidden');
                rangeCircle.addTo(map);
                centerMarker.addTo(map);
                map.setView([centerLat, centerLng], 8);
            }
        };

        slider.oninput = function() {
            radiusKm = parseInt(this.value);
            radiusDisplay.innerText = radiusKm;
            rangeCircle.setRadius(radiusKm * 1000);
        };

        function togglePanel() {
            const p = document.getElementById('controls');
            const b = document.getElementById('toggle-btn');
            p.classList.toggle('minimized');
            b.innerText = p.classList.contains('minimized') ? 'â˜' : '_';
        }
    </script>
</body>
</html>
