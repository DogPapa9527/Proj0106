<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬æ—…éŠå°„é£›é¢ - ä¿®æ­£ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZn1r2Jpne1I2rOms85YwGNvs029XGMcib8J9OH66/4f7c1lDQ6woGw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        body { font-family: "Microsoft JhengHei", "Hiragino Sans", sans-serif; }
        
        /* çµ¦åœ°åœ–ä¸€å€‹é è¨­åº•è‰²ï¼Œç¢ºèªå®¹å™¨å­˜åœ¨ */
        #map { height: 100vh; width: 100%; z-index: 1; background-color: #e5e5e5; }
        
        /* æ§åˆ¶é¢æ¿æ¨£å¼ */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 300px;
            backdrop-filter: blur(5px);
        }
        h2 { margin-top: 0; font-size: 1.2rem; color: #333; border-bottom: 2px solid #ff5252; padding-bottom: 10px;}
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555;}
        input[type="range"] { width: 100%; }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            background: #f0f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .checkbox-group input { margin-right: 10px; transform: scale(1.2); }
        .checkbox-group label { margin-bottom: 0; cursor: pointer; }

        #circle-controls-wrapper { transition: opacity 0.3s, filter 0.3s; }
        .disabled-controls { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }

        button {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 12px 20px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background-color: #e04040; }
        
        #result-display {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.6;
            word-break: break-all;
        }
        a.gmap-link {
            color: #d93025;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        .tip { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="controls">
        <h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬æ—…éŠå°„é£›é¢</h2>
        
        <div class="checkbox-group control-group">
            <input type="checkbox" id="japan-wide-check">
            <label for="japan-wide-check">ğŸ—¾ æŒ‘æˆ°å…¨æ—¥æœ¬ç¯„åœï¼(éš¨æ©Ÿ)</label>
        </div>

        <div id="circle-controls-wrapper">
            <div class="control-group">
                <label>è‡ªè¨‚ç¯„åœåŠå¾‘: <span id="radius-val">100</span> km</label>
                <input type="range" id="radius-slider" min="10" max="1000" value="100" step="10">
            </div>
            <p class="tip">ğŸ’¡ æ‹–æ›³åœ°åœ–ä¸Šçš„è—è‰²æ¨™è¨˜ä¾†æ”¹è®Šä¸­å¿ƒé»</p>
        </div>
        
        <button onclick="throwDart()">ğŸ¯ å°„å‡ºé£›é¢ï¼</button>
        
        <div id="result-display">æº–å‚™å¥½é–‹å§‹ä½ çš„æ—¥æœ¬å†’éšªäº†å—ï¼Ÿ</div>
    </div>

    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // 1. åˆå§‹åŒ–åœ°åœ–
        // ç¢ºä¿åœ°åœ–ç‰©ä»¶åœ¨ DOM è¼‰å…¥å¾Œæ­£ç¢ºå»ºç«‹
        const map = L.map('map').setView([38.0, 137.0], 5);

        // ä½¿ç”¨ HTTPS çš„ OSM åœ–è³‡
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 2. è®Šæ•¸èˆ‡ UI
        let centerLat = 35.6895; // æ±äº¬
        let centerLng = 139.6917;
        let radiusKm = 100;
        let resultMarker = null;

        const japanWideCheck = document.getElementById('japan-wide-check');
        const circleControlsWrapper = document.getElementById('circle-controls-wrapper');
        const slider = document.getElementById('radius-slider');
        const radiusDisplay = document.getElementById('radius-val');

        // 3. å»ºç«‹åœ“å½¢æ¨¡å¼å…ƒä»¶
        const centerMarker = L.marker([centerLat, centerLng], {draggable: true}).addTo(map);
        centerMarker.bindPopup("å‡ºç™¼ä¸­å¿ƒé» (å¯æ‹–æ›³)").openPopup();

        const rangeCircle = L.circle([centerLat, centerLng], {
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.15,
            weight: 2,
            radius: radiusKm * 1000
        }).addTo(map);

        // 4. äº‹ä»¶ç›£è½
        japanWideCheck.onchange = function() {
            if (this.checked) {
                circleControlsWrapper.classList.add('disabled-controls');
                map.removeLayer(rangeCircle);
                map.removeLayer(centerMarker);
                map.flyTo([38.0, 137.0], 5);
            } else {
                circleControlsWrapper.classList.remove('disabled-controls');
                rangeCircle.addTo(map);
                centerMarker.addTo(map);
                map.flyTo([centerLat, centerLng], 8);
            }
        }

        centerMarker.on('drag', function(e) {
            const newPos = e.target.getLatLng();
            centerLat = newPos.lat;
            centerLng = newPos.lng;
            rangeCircle.setLatLng(newPos);
        });

        slider.oninput = function() {
            radiusKm = parseInt(this.value);
            radiusDisplay.innerText = radiusKm;
            rangeCircle.setRadius(radiusKm * 1000);
        }

        // 5. å°„é£›é¢é‚è¼¯
        function throwDart() {
            if (resultMarker) map.removeLayer(resultMarker);
            document.getElementById('result-display').innerHTML = "ğŸš€ é£›é¢é£›è¡Œä¸­...";

            let targetLat, targetLng, resultMsgHtml;
            const isJapanWide = japanWideCheck.checked;

            if (isJapanWide) {
                // çŸ©å½¢ç¯„åœ
                const minLat = 24.0, maxLat = 45.6;
                const minLng = 122.9, maxLng = 146.0;
                targetLat = Math.random() * (maxLat - minLat) + minLat;
                targetLng = Math.random() * (maxLng - minLng) + minLng;
                resultMsgHtml = `ğŸ—¾ æ¨¡å¼: å…¨æ—¥æœ¬éš¨æ©ŸæŒ‘æˆ°`;
            } else {
                // åœ“å½¢ç¯„åœ
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.sqrt(Math.random()) * radiusKm;
                const earthRadius = 6371;
                const deltaLat = (distance * Math.cos(angle) / earthRadius) * (180 / Math.PI);
                const deltaLng = (distance * Math.sin(angle) / (earthRadius * Math.cos(centerLat * Math.PI / 180))) * (180 / Math.PI);
                targetLat = centerLat + deltaLat;
                targetLng = centerLng + deltaLng;
                resultMsgHtml = `â­• æ¨¡å¼: ç¯„åœå…§ ${distance.toFixed(1)} km`;
            }

            setTimeout(() => {
                const redIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                resultMarker = L.marker([targetLat, targetLng], {icon: redIcon}).addTo(map);
                const targetZoom = isJapanWide ? 9 : 11;
                map.flyTo([targetLat, targetLng], targetZoom, { animate: true, duration: 1.5 });

                // ä¿®æ­£å¾Œçš„ Google Maps é€£çµ (ä½¿ç”¨ HTTPS å’Œæ­£ç¢ºåƒæ•¸)
                const gmapUrl = `https://www.google.com/maps?q=${targetLat},${targetLng}`;
                
                const popupContent = `<b>å‘½ä¸­ï¼</b><br><a href="${gmapUrl}" target="_blank" class="gmap-link">åœ¨ Google Maps é–‹å•Ÿ</a>`;
                resultMarker.bindPopup(popupContent).openPopup();

                document.getElementById('result-display').innerHTML = 
                    `${resultMsgHtml}<br>ğŸ“ <a href="${gmapUrl}" target="_blank" class="gmap-link">åœ¨ Google Maps æŸ¥çœ‹çµæœ</a>`;
            }, 500);
        }
    </script>
</body>
</html>
