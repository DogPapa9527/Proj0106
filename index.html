<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬è‡ªé§•éŠ - éš¨æ©Ÿèˆ‡è¦åŠƒ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #aad3df; }
        
        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 320px;
            transition: all 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        #controls.minimized { width: 180px; padding-bottom: 5px; }
        #controls.minimized #panel-content { display: none; }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #ff5252;
            padding-bottom: 8px;
        }
        h2 { margin: 0; font-size: 1.1rem; color: #333; }
        #toggle-btn {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #555;
        }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• (Radio Style) */
        .mode-switcher {
            display: flex;
            background: #eee;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
        }
        .mode-switcher label {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #666;
            font-weight: bold;
            transition: all 0.2s;
        }
        .mode-switcher input { display: none; }
        /* é¸ä¸­ç‹€æ…‹ */
        .mode-switcher input:checked + label {
            background: #fff;
            color: #ff5252;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-group { margin-bottom: 15px; }
        .label-title { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #333; }
        
        input[type="range"] { width: 100%; }

        .checkbox-group {
            background: #f8f9fa; padding: 10px; border-radius: 5px;
            display: flex; align-items: center;
        }
        .checkbox-group input { margin-right: 10px; transform: scale(1.2); }
        .checkbox-group label { margin: 0; cursor: pointer; font-size: 0.9rem; }

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none; }

        button.action-btn {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 4px 6px rgba(255,82,82,0.3);
        }
        button.action-btn:hover { background-color: #d32f2f; }
        button.action-btn.blue { background-color: #4285f4; box-shadow: 0 4px 6px rgba(66,133,244,0.3); }
        button.action-btn.blue:hover { background-color: #3367d6; }

        #result-display {
            margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;
            font-size: 0.9rem; color: #555; line-height: 1.5;
        }
        a.gmap-link {
            color: white; background: #4285f4; padding: 6px 12px;
            border-radius: 4px; text-decoration: none; font-weight: bold;
            display: inline-block; margin-top: 8px; font-size: 0.9rem;
        }

        /* Leaflet Marker CSS Filters (æ”¹è®Šé¡è‰²) */
        img.huechange-green { filter: hue-rotate(240deg) brightness(1.2); } /* è®Šç¶ è‰² (èµ·é») */
        img.huechange-red { filter: hue-rotate(0deg); } /* ç´…è‰² (é è¨­) */
        
    </style>
</head>
<body>

    <div id="controls">
        <div class="header-bar">
            <h2>ğŸ‡¯ğŸ‡µ æ—¥æœ¬è‡ªé§•åœ°åœ–</h2>
            <button id="toggle-btn" onclick="togglePanel()">_</button>
        </div>

        <div id="panel-content">
            <div class="mode-switcher">
                <input type="radio" id="mode-random" name="mode" value="random" checked onchange="switchMode()">
                <label for="mode-random">ğŸ¯ éš¨æ©Ÿå†’éšª</label>
                
                <input type="radio" id="mode-manual" name="mode" value="manual" onchange="switchMode()">
                <label for="mode-manual">ğŸš— è‡ªé§•è¦åŠƒ</label>
            </div>

            <div id="controls-random">
                <div class="control-group checkbox-group">
                    <input type="checkbox" id="japan-wide-check">
                    <label for="japan-wide-check">ğŸ—¾ å…¨æ—¥æœ¬ç¯„åœ (é™¸åœ°)</label>
                </div>
                <div id="circle-controls">
                    <div class="control-group">
                        <span class="label-title">æœå°‹åŠå¾‘: <span id="radius-val">100</span> km</span>
                        <input type="range" id="radius-slider" min="10" max="1000" value="100" step="10">
                    </div>
                    <p style="font-size: 0.8rem; color: #666;">ğŸ’¡ æ‹–æ›³åœ°åœ–ä¸Šçš„ <b style="color:green">ç¶ è‰²æ¨™è¨˜</b> è¨­å®šèµ·é»</p>
                </div>
                <button class="action-btn" onclick="throwDart()">ğŸ¯ å¹«æˆ‘æ±ºå®šç›®çš„åœ°ï¼</button>
            </div>

            <div id="controls-manual" class="hidden">
                <p style="font-size: 0.9rem; color: #555;">è«‹åœ¨åœ°åœ–ä¸Šæ‹–æ›³æ¨™è¨˜ï¼š</p>
                <ul style="padding-left: 20px; font-size: 0.9rem; margin-top:5px;">
                    <li><b style="color: #2ecc71;">ç¶ è‰²</b>ï¼šå‡ºç™¼åœ° (èµ·é»)</li>
                    <li><b style="color: #e74c3c;">ç´…è‰²</b>ï¼šç›®çš„åœ° (çµ‚é»)</li>
                </ul>
                <button class="action-btn blue" onclick="openRoute()">ğŸ—ºï¸ é–‹å•Ÿ Google å°èˆª</button>
            </div>
            
            <div id="result-display">æº–å‚™å‡ºç™¼ï¼</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. åˆå§‹åŒ–åœ°åœ–
        const map = L.map('map').setView([35.6895, 139.6917], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // 2. å…¨å±€è®Šæ•¸
        let currentMode = 'random';
        let startMarker = null; // èµ·é» (ç¶ )
        let endMarker = null;   // çµ‚é» (ç´…)
        let rangeCircle = null; // ç¯„åœåœ“åœˆ
        let routeLine = null;   // é€£æ¥ç·š

        let centerLat = 35.6895; // é è¨­æ±äº¬
        let centerLng = 139.6917;
        let radiusKm = 100;

        // UI å…ƒç´ 
        const controlsPanel = document.getElementById('controls');
        const toggleBtn = document.getElementById('toggle-btn');
        const japanWideCheck = document.getElementById('japan-wide-check');
        const slider = document.getElementById('radius-slider');
        const radiusDisplay = document.getElementById('radius-val');

        // 3. åœ–æ¨™æ¨£å¼ (ä½¿ç”¨ CSS Filter è®Šè‰²)
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // 4. åˆå§‹åŒ–åŠŸèƒ½
        initMapElements();

        function initMapElements() {
            // å»ºç«‹èµ·é» (å…±ç”¨)
            startMarker = L.marker([centerLat, centerLng], {draggable: true, icon: greenIcon}).addTo(map);
            startMarker.bindPopup("<b>ğŸ èµ·é» (å‡ºç™¼åœ°)</b><br>æ‹–æ›³æˆ‘ä¾†æ”¹è®Šä½ç½®").openPopup();

            // å»ºç«‹åœ“åœˆ (éš¨æ©Ÿæ¨¡å¼ç”¨)
            rangeCircle = L.circle([centerLat, centerLng], {
                color: '#3388ff', fillColor: '#3388ff', fillOpacity: 0.1, radius: radiusKm * 1000
            }).addTo(map);

            // å»ºç«‹çµ‚é» (è¦åŠƒæ¨¡å¼ç”¨ï¼Œé è¨­éš±è—)
            // é è¨­çµ‚é»æ”¾åœ¨èµ·é»æ—é‚Šä¸€é»é»
            endMarker = L.marker([centerLat + 0.5, centerLng + 0.5], {draggable: true, icon: redIcon});
            
            // å»ºç«‹é€£ç·š (é è¨­éš±è—)
            routeLine = L.polyline([], {color: '#4285f4', weight: 4, opacity: 0.7, dashArray: '10, 10'});

            // äº‹ä»¶ç›£è½
            startMarker.on('drag', (e) => {
                const pos = e.target.getLatLng();
                centerLat = pos.lat;
                centerLng = pos.lng;
                rangeCircle.setLatLng(pos);
                updateRouteLine();
            });

            endMarker.on('drag', () => {
                updateRouteLine();
            });
        }

        // 5. æ¨¡å¼åˆ‡æ›é‚è¼¯
        function switchMode() {
            const radios = document.getElementsByName('mode');
            for(let r of radios) { if(r.checked) currentMode = r.value; }

            const divRandom = document.getElementById('controls-random');
            const divManual = document.getElementById('controls-manual');

            if (currentMode === 'random') {
                // --- åˆ‡æ›åˆ° éš¨æ©Ÿæ¨¡å¼ ---
                divRandom.classList.remove('hidden');
                divManual.classList.add('hidden');
                
                // é¡¯ç¤ºåœ“åœˆï¼Œéš±è—æ‰‹å‹•çµ‚é»
                if (!japanWideCheck.checked) rangeCircle.addTo(map);
                map.removeLayer(endMarker);
                map.removeLayer(routeLine);
                document.getElementById('result-display').innerHTML = "æº–å‚™å°„é£›é¢...";
            } else {
                // --- åˆ‡æ›åˆ° è¦åŠƒæ¨¡å¼ ---
                divRandom.classList.add('hidden');
                divManual.classList.remove('hidden');
                
                // éš±è—åœ“åœˆï¼Œé¡¯ç¤ºæ‰‹å‹•çµ‚é»èˆ‡é€£ç·š
                map.removeLayer(rangeCircle);
                endMarker.addTo(map).bindPopup("<b>ğŸ çµ‚é» (ç›®çš„åœ°)</b>").openPopup();
                routeLine.addTo(map);
                
                // è‡ªå‹•ç¸®æ”¾è®“èµ·çµ‚é»éƒ½åœ¨ç•«é¢å…§
                const group = new L.featureGroup([startMarker, endMarker]);
                map.fitBounds(group.getBounds().pad(0.2));
                
                updateRouteLine();
                document.getElementById('result-display').innerHTML = "æ‹–æ›³æ¨™è¨˜ä¾†è¦åŠƒè·¯ç·š";
            }
        }

        // æ›´æ–°é€£ç·šèˆ‡è·é›¢é¡¯ç¤º (å…±ç”¨å‡½å¼)
        function updateRouteLine() {
            if (currentMode === 'manual' || map.hasLayer(endMarker)) {
                const startLatLng = startMarker.getLatLng();
                const endLatLng = endMarker.getLatLng();
                
                // ç•«ç·š
                routeLine.setLatLngs([startLatLng, endLatLng]);
                if (currentMode === 'manual') routeLine.addTo(map);

                // è¨ˆç®—è·é›¢
                const dist = (startLatLng.distanceTo(endLatLng) / 1000).toFixed(1);
                document.getElementById('result-display').innerHTML = 
                    `ğŸ“ ç›´ç·šè·é›¢: <b>${dist} km</b><br>` +
                    `<span style="font-size:0.8rem; color:#888;">(é»æ“ŠæŒ‰éˆ•æŸ¥çœ‹å¯¦éš›è¡Œè»Šè·¯ç·š)</span>`;
            }
        }

        // 6. éš¨æ©Ÿæ¨¡å¼é‚è¼¯ (å«å€åŸŸé¿æµ·ç®—æ³•)
        const japanZones = [
            { name: "åŒ—æµ·é“", minLat: 41.5, maxLat: 45.3, minLng: 140.0, maxLng: 145.5, weight: 2 },
            { name: "æ±åŒ—åœ°å€", minLat: 37.0, maxLat: 41.5, minLng: 139.5, maxLng: 141.5, weight: 2 },
            { name: "é—œæ±/ä¸­éƒ¨", minLat: 34.8, maxLat: 37.0, minLng: 137.0, maxLng: 140.5, weight: 3 },
            { name: "é—œè¥¿/å››åœ‹", minLat: 33.0, maxLat: 35.5, minLng: 132.5, maxLng: 136.0, weight: 2 },
            { name: "ä¸­åœ‹/ä¹å·", minLat: 31.0, maxLat: 34.5, minLng: 129.5, maxLng: 132.5, weight: 2 },
            { name: "æ²–ç¹©", minLat: 26.0, maxLat: 27.0, minLng: 127.5, maxLng: 128.3, weight: 0.5 }
        ];

        function getRandomPointInJapan() {
            const totalWeight = japanZones.reduce((sum, zone) => sum + zone.weight, 0);
            let random = Math.random() * totalWeight;
            let selectedZone = japanZones[0];
            for (let zone of japanZones) {
                if (random < zone.weight) { selectedZone = zone; break; }
                random -= zone.weight;
            }
            return {
                lat: Math.random() * (selectedZone.maxLat - selectedZone.minLat) + selectedZone.minLat,
                lng: Math.random() * (selectedZone.maxLng - selectedZone.minLng) + selectedZone.minLng,
                name: selectedZone.name
            };
        }

        function throwDart() {
            map.removeLayer(endMarker);
            map.removeLayer(routeLine);
            document.getElementById('result-display').innerHTML = "ğŸš€ é£›é¢é£›è¡Œä¸­...";

            let targetLat, targetLng, infoText;

            // è¨ˆç®—ç›®æ¨™é»
            if (japanWideCheck.checked) {
                const point = getRandomPointInJapan();
                targetLat = point.lat; targetLng = point.lng;
                infoText = `(å€åŸŸ: ${point.name})`;
            } else {
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.sqrt(Math.random()) * radiusKm;
                const deltaLat = (distance * Math.cos(angle) / 6371) * (180 / Math.PI);
                const deltaLng = (distance * Math.sin(angle) / (6371 * Math.cos(centerLat * Math.PI / 180))) * (180 / Math.PI);
                targetLat = centerLat + deltaLat;
                targetLng = centerLng + deltaLng;
                infoText = `(è·é›¢: ${distance.toFixed(1)} km)`;
            }

            // å‹•ç•«èˆ‡çµæœ
            setTimeout(() => {
                // è¨­å®šçµ‚é»æ¨™è¨˜ä½ç½®
                endMarker.setLatLng([targetLat, targetLng]).addTo(map);
                
                // ç•«ç·š (é€™å°±æ˜¯ç®­é ­åŠŸèƒ½)
                routeLine.setLatLngs([startMarker.getLatLng(), [targetLat, targetLng]]).addTo(map);

                // ç¸®æ”¾åœ°åœ–åŒ…ä½è·¯å¾‘
                const group = new L.featureGroup([startMarker, endMarker]);
                map.fitBounds(group.getBounds().pad(0.2));

                const gmapUrl = `https://www.google.com/maps/dir/?api=1&origin=${centerLat},${centerLng}&destination=${targetLat},${targetLng}&travelmode=driving`;

                const popupContent = `<b>ğŸ¯ å‘½ä¸­ï¼</b><br><a href="${gmapUrl}" target="_blank" class="gmap-link">ğŸš— Google å°èˆªè·¯ç·š</a>`;
                endMarker.bindPopup(popupContent).openPopup();

                document.getElementById('result-display').innerHTML = 
                    `ğŸ“ å‘½ä¸­åº§æ¨™ï¼ ${infoText}<br>` +
                    `<a href="${gmapUrl}" target="_blank" class="gmap-link">ğŸ—ºï¸ æŸ¥çœ‹é–‹è»Šè·¯ç·š (å«èµ·çµ‚é»)</a>`;
            }, 500);
        }

        // 7. è¦åŠƒæ¨¡å¼æŒ‰éˆ•é‚è¼¯
        function openRoute() {
            const start = startMarker.getLatLng();
            const end = endMarker.getLatLng();
            // Google Maps Dir API æ ¼å¼
            const url = `https://www.google.com/maps/dir/?api=1&origin=${start.lat},${start.lng}&destination=${end.lat},${end.lng}&travelmode=driving`;
            window.open(url, '_blank');
        }

        // å…¶ä»– UI äº‹ä»¶
        japanWideCheck.onchange = function() {
            const circleDiv = document.getElementById('circle-controls');
            if (this.checked) {
                circleDiv.classList.add('hidden');
                map.removeLayer(rangeCircle);
                map.setView([38.0, 137.0], 5);
            } else {
                circleDiv.classList.remove('hidden');
                rangeCircle.addTo(map);
                map.setView([centerLat, centerLng], 8);
            }
        };

        slider.oninput = function() {
            radiusKm = parseInt(this.value);
            radiusDisplay.innerText = radiusKm;
            rangeCircle.setRadius(radiusKm * 1000);
        };

        function togglePanel() {
            controlsPanel.classList.toggle('minimized');
            toggleBtn.innerText = controlsPanel.classList.contains('minimized') ? 'â˜' : '_';
        }
    </script>
</body>
</html>
