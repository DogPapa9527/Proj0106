<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°åœ–å°„é£›é¢ - éš¨æ©Ÿæ—…éŠç”¢ç”Ÿå™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* æ§åˆ¶é¢æ¿æ¨£å¼ */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 300px;
        }
        h2 { margin-top: 0; font-size: 1.2rem; color: #333; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="range"] { width: 100%; }
        
        button {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 12px 20px;
            width: 100%;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background-color: #e04040; }
        
        #result-display {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #555;
        }
        a.gmap-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="controls">
        <h2>ğŸ¯ éš¨æ©Ÿæ—…éŠå°„é£›é¢</h2>
        <div class="control-group">
            <label>ç¯„åœåŠå¾‘: <span id="radius-val">50</span> km</label>
            <input type="range" id="radius-slider" min="5" max="500" value="50">
        </div>
        <p style="font-size: 0.8rem; color: #666;">ğŸ’¡ æ‹–æ›³è—è‰²æ¨™è¨˜ä¾†æ”¹è®Šä¸­å¿ƒé»</p>
        <button onclick="throwDart()">å°„å‡ºé£›é¢ï¼</button>
        
        <div id="result-display">æº–å‚™å¥½å¾Œè«‹æŒ‰æŒ‰éˆ•...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­ä¸­å¿ƒï¼šå°ç£åœ°ç†ä¸­å¿ƒé™„è¿‘)
        const map = L.map('map').setView([23.97565, 120.97388], 8);

        // åŠ å…¥ OpenStreetMap åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // 2. è¨­å®šè®Šæ•¸
        let centerLat = 23.97565;
        let centerLng = 120.97388;
        let radiusKm = 50;
        let resultMarker = null;

        // 3. å»ºç«‹ä¸­å¿ƒé»æ¨™è¨˜ (å¯æ‹–æ›³)
        const centerMarker = L.marker([centerLat, centerLng], {draggable: true}).addTo(map);
        centerMarker.bindPopup("é€™æ˜¯åœ“å¿ƒ (æ‹–æ›³æˆ‘)").openPopup();

        // 4. å»ºç«‹ç¯„åœåœ“åœˆ
        const rangeCircle = L.circle([centerLat, centerLng], {
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.2,
            radius: radiusKm * 1000 // å…¬å°º
        }).addTo(map);

        // 5. æ›´æ–°äº‹ä»¶ç›£è½
        
        // ç•¶æ¨™è¨˜è¢«æ‹–æ›³æ™‚ï¼Œæ›´æ–°åœ“åœˆä½ç½®
        centerMarker.on('drag', function(e) {
            const newPos = e.target.getLatLng();
            centerLat = newPos.lat;
            centerLng = newPos.lng;
            rangeCircle.setLatLng(newPos);
        });

        // ç•¶æ‹‰æ¡¿æ»‘å‹•æ™‚ï¼Œæ›´æ–°åŠå¾‘
        const slider = document.getElementById('radius-slider');
        const radiusDisplay = document.getElementById('radius-val');

        slider.oninput = function() {
            radiusKm = parseInt(this.value);
            radiusDisplay.innerText = radiusKm;
            rangeCircle.setRadius(radiusKm * 1000);
        }

        // 6. æ ¸å¿ƒé‚è¼¯ï¼šå°„é£›é¢ (ç”¢ç”Ÿéš¨æ©Ÿåº§æ¨™)
        function throwDart() {
            // æ¸…é™¤ä¸Šä¸€æ¬¡çš„çµæœ
            if (resultMarker) {
                map.removeLayer(resultMarker);
            }
            document.getElementById('result-display').innerHTML = "é£›é¢é£›è¡Œä¸­... âœˆï¸";

            // ä½¿ç”¨æ•¸å­¸è¨ˆç®—åœ“å…§çš„éš¨æ©Ÿé»
            // éš¨æ©Ÿè§’åº¦ (0 åˆ° 2PI)
            const angle = Math.random() * Math.PI * 2;
            
            // éš¨æ©Ÿè·é›¢ (ä½¿ç”¨ sqrt ç¢ºä¿åˆ†å¸ƒå‡å‹»ï¼Œå¦å‰‡é»æœƒé›†ä¸­åœ¨åœ“å¿ƒ)
            const distance = Math.sqrt(Math.random()) * radiusKm;

            // å°‡è·é›¢èˆ‡è§’åº¦è½‰æ›ç‚ºç¶“ç·¯åº¦åç§»é‡ (ç°¡æ˜“è¨ˆç®—)
            // åœ°çƒå¹³å‡åŠå¾‘ç´„ 6371km
            const earthRadius = 6371;
            
            const deltaLat = (distance * Math.cos(angle) / earthRadius) * (180 / Math.PI);
            // ç¶“åº¦éœ€è¦è€ƒæ…®ç·¯åº¦çš„ä¿®æ­£
            const deltaLng = (distance * Math.sin(angle) / (earthRadius * Math.cos(centerLat * Math.PI / 180))) * (180 / Math.PI);

            const targetLat = centerLat + deltaLat;
            const targetLng = centerLng + deltaLng;

            // 7. å‹•ç•«èˆ‡çµæœé¡¯ç¤º
            setTimeout(() => {
                // æ–°å¢ç´…è‰²é£›é¢æ¨™è¨˜
                resultMarker = L.marker([targetLat, targetLng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);

                // é£›åˆ°è©²åœ°é»
                map.flyTo([targetLat, targetLng], 10, {
                    animate: true,
                    duration: 1.5
                });

                // ç”Ÿæˆ Google Maps é€£çµ
                const gmapUrl = `https://www.google.com/maps/search/?api=1&query=${targetLat},${targetLng}`;

                resultMarker.bindPopup(`<b>ğŸ¯ å‘½ä¸­åœ°é»ï¼</b><br><a href="${gmapUrl}" target="_blank" class="gmap-link">åœ¨ Google Maps é–‹å•Ÿ</a>`).openPopup();

                document.getElementById('result-display').innerHTML = 
                    `åº§æ¨™: ${targetLat.toFixed(4)}, ${targetLng.toFixed(4)}<br>` +
                    `è·é›¢ä¸­å¿ƒ: ${distance.toFixed(1)} km<br>` +
                    `<a href="${gmapUrl}" target="_blank" class="gmap-link">ğŸ“ åœ¨ Google Maps æŸ¥çœ‹</a>`;

            }, 500); // ç¨å¾®å»¶é²æ¨¡æ“¬æ€è€ƒ
        }
    </script>
</body>
</html>
